%% Learn from Sourcefile MVP - Detailed Flow with Lazy Audio
%% Prompt: Diagram showing Learn flow with lazy audio generation to prevent timeouts.
%% Key change: /generate uses skip_audio=true, audio fetched on-demand via /ensure-audio
%% Files: backend/views/learn_api.py, frontend/.../learn/+page.svelte
%% Updated: 260102 after implementing lazy audio generation

flowchart TB
  subgraph User["üë§ User"]
    U1[Opens Learn page]
    U2[Browses priority words]
    U3[Clicks Start Practice]
    U4[Navigates flashcards]
  end

  subgraph Browser["üåê Browser - SvelteKit"]
    direction TB
    subgraph Init["Page Mount"]
      F1[fetchSummary]
      F2[Fetch sourcefile text]
      F3[Fetch ignored lemmas]
    end
    
    subgraph Background["Background Tasks"]
      BG1[warmTopLemmasInBackground<br/>p-queue concurrency=2]
      BG2["preparePracticeInBackground<br/>POST /generate skip_audio=true"]
    end
    
    subgraph Practice["Practice Mode"]
      P1[startOrShowPractice]
      P2[Show card with spinner]
      P3["prefetchAudioForCard<br/>current + next 2 cards"]
      P4[AudioPlayer autoplay]
      P5["GET /sentence/.../audio<br/>Stream audio blob"]
    end
    
    F1 -->|on success| BG1
    F1 -->|on success| BG2
    P1 --> P2
    P2 --> P3
    P3 -->|audio ready| P4
    P4 --> P5
  end

  subgraph Backend["üîß Flask Backend"]
    direction TB
    
    subgraph Summary["GET /summary endpoint<br/>time_budget_s: 3-45s, default 12s"]
      S1[get_sourcefile_lemmas]
      S2[Bulk fetch Lemma rows]
      S3{Time budget?}
      S4[load_or_generate_lemma_metadata]
      S5[Fallback defaults]
      S6[Score & rank]
      S7[Return top-K lemmas]
    end
    
    subgraph LemmaAPI["GET /lemma/{lemma}/metadata"]
      L1[load_or_generate_lemma_metadata]
      L2{Complete?}
      L3["üê¢ LLM metadata ~2-5s"]
      L4[Return cached]
    end
    
    subgraph Generate["POST /generate endpoint<br/>‚úÖ FAST with skip_audio=true"]
      G1[Resolve Sourcefile FK]
      G2[Query existing Sentences]
      G3{Has enough<br/>reused?}
      G4["Check existing audio<br/>(cheap DB lookup)"]
      G5{Authenticated?}
      G6[Return 401 + reused]
      G7["üê¢ LLM sentences<br/>~5-15s"]
      G8[Persist Sentence rows]
      G9["Return sentences<br/>with sentence_id<br/>audio_status: pending/ready"]
    end
    
    subgraph EnsureAudio["POST /ensure-audio endpoint<br/>‚úÖ Single TTS call ~3-8s"]
      EA1[Lookup Sentence]
      EA2{Audio exists?}
      EA3[Return cached URL]
      EA4{Authenticated?}
      EA5[Return 401]
      EA6["üê¢ TTS: ElevenLabs<br/>~3-8s single call"]
      EA7[Store audio blob]
      EA8[Return audio URL]
    end
    
    subgraph Audio["Audio Storage"]
      A1[SentenceAudio table<br/>MP3 blobs in Postgres]
    end
  end

  subgraph External["‚òÅÔ∏è External Services"]
    EXT1["Anthropic Claude<br/>LLM"]
    EXT2["ElevenLabs<br/>TTS"]
  end

  subgraph DB["üóÑÔ∏è Supabase PostgreSQL"]
    DB1[(Lemma)]
    DB2[(Sentence)]
    DB3[(SentenceAudio)]
    DB4[(SentenceLemma)]
  end

  %% User flow
  U1 --> F1
  U2 --> BG1
  U3 --> P1
  U4 --> P3

  %% Frontend to Backend - Fast path
  F1 -->|"GET /summary"| S1
  BG1 -->|"GET /lemma/..."| L1
  BG2 -->|"POST /generate<br/>skip_audio=true<br/>~5-15s"| G1
  P1 -->|"Use prepared deck"| P2
  P3 -->|"POST /ensure-audio<br/>~3-8s per card"| EA1
  P5 -->|"GET audio blob"| A1

  %% Summary flow
  S1 --> S2 --> S3
  S3 -->|yes| S4 --> S6
  S3 -->|no| S5 --> S6
  S6 --> S7

  %% Lemma API flow
  L1 --> L2
  L2 -->|no| L3 --> L4
  L2 -->|yes| L4

  %% Generate flow - FAST (no TTS)
  G1 --> G2 --> G3
  G3 -->|yes| G4 --> G9
  G3 -->|no| G5
  G5 -->|no| G6
  G5 -->|yes| G7 --> G8 --> G9

  %% Ensure-audio flow - Single TTS
  EA1 --> EA2
  EA2 -->|yes| EA3
  EA2 -->|no| EA4
  EA4 -->|no| EA5
  EA4 -->|yes| EA6 --> EA7 --> EA8

  %% External calls
  L3 -->|"~2-5s"| EXT1
  G7 -->|"~5-15s"| EXT1
  EA6 -->|"~3-8s"| EXT2

  %% Database
  S2 --> DB1
  L1 --> DB1
  G2 --> DB2
  G4 --> DB3
  G8 --> DB2
  G8 --> DB4
  EA7 --> DB3
  A1 --> DB3

  %% Styling
  classDef timeout fill:#ff6b6b,stroke:#c92a2a,color:#fff
  classDef fast fill:#51cf66,stroke:#37b24d,color:#000
  classDef external fill:#ffd43b,stroke:#fab005,color:#000
  classDef db fill:#69db7c,stroke:#37b24d,color:#000
  
  class L3,G7,EA6 timeout
  class G9,EA3,EA8 fast
  class EXT1,EXT2 external
  class DB1,DB2,DB3,DB4,A1 db
