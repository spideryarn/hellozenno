# Security Vulnerability Remediation Plan

## Goal, Context

Address 20 security vulnerabilities identified by GitHub Dependabot in the HelloZenno codebase after recent commits. The vulnerabilities span critical to low severity, with immediate focus required on 1 critical and 1 high severity issue that could affect production security.

GitHub reported these vulnerabilities during push of flashcard error handling improvements, highlighting the need for systematic dependency updates and security practices.

## References

- `CLAUDE.md` - Project AI agent instructions and development guidelines
- `backend/docs/DEVOPS.md` - Deployment and operations documentation
- GitHub Security Advisory Database - https://github.com/advisories
- NPM Security Documentation - https://docs.npmjs.com/auditing-package-dependencies-for-security-vulnerabilities

## Principles, Key Decisions

- Prioritize production-affecting vulnerabilities (critical/high) over development-only issues
- Create backups before any dependency updates to enable quick rollback
- Test thoroughly after each update phase to catch breaking changes early
- Remove legacy code (`backend/old_frontend/`) if confirmed unused to reduce attack surface
- Implement automated security scanning for future prevention

## Critical & High Priority Vulnerabilities

### 1. form-data - Unsafe Random Function (CRITICAL - CVE-2025-7783)
**Severity**: Critical (CVSS 9.4)
**Current Version**: 4.0.2
**Fixed Version**: 4.0.4+
**Location**: Dependency of `jsdom@26.0.0`

**Issue**:
- Uses Math.random() for multipart boundary generation
- Allows attackers to predict boundaries and manipulate form submissions
- Can lead to HTTP parameter pollution attacks

**References**:
- GitHub Advisory: https://github.com/form-data/form-data/security/advisories/GHSA-fjxv-7rqg-78g4
- Socket.dev Analysis: https://socket.dev/blog/critical-vulnerability-in-popular-npm-form-data-package
- Resolved Security Guide: https://www.resolvedsecurity.com/post/cve-2025-7783-fix-the-form-data-risk-fast
- GitLab Advisory: https://advisories.gitlab.com/pkg/npm/form-data/CVE-2025-7783/

**Remediation**:
```bash
# Update jsdom which includes form-data
cd frontend
npm update jsdom
# If that doesn't work, try:
npm install jsdom@latest
```

### 2. devalue - Prototype Pollution (HIGH - CVE-2025-57820)
**Severity**: High
**Current Version**: 5.1.1
**Fixed Version**: 5.3.2+
**Location**: Dependency of `@sveltejs/kit@2.20.2`

**Issue**:
- Allows prototype pollution through crafted input like `[{"toString":"push"}]`
- Can bypass server-side validation
- Potential for arbitrary property injection

**References**:
- GitHub Advisory: https://github.com/sveltejs/devalue/security/advisories/GHSA-vj54-72f3-p5jv
- CVE Details: https://cvefeed.io/vuln/detail/CVE-2025-57820
- GitLab Advisory: https://advisories.gitlab.com/pkg/npm/devalue/CVE-2025-57820/

**Remediation**:
```bash
cd frontend
npm update @sveltejs/kit
# This should update devalue to a safe version
```

## Moderate Priority Vulnerabilities

### 3-14. Vite server.fs.deny Bypasses (MODERATE)
**Current Version**: 6.2.3
**Affected CVEs**:
- CVE-2024-45811 (Fixed in 5.4.6+) - https://vulert.com/vuln-db/CVE-2024-45811
- CVE-2024-31207 (Fixed in 5.2.6+) - https://security.snyk.io/vuln/SNYK-JS-VITE-6531286
- CVE-2024-23331 (Fixed in 5.0.12+) - https://nvd.nist.gov/vuln/detail/CVE-2024-23331
- Additional similar bypasses

**Issue**:
- Multiple ways to bypass file access restrictions
- Affects development server only (not production)
- Can expose sensitive files when dev server is network-exposed

**References**:
- Vite Security Advisories: https://github.com/vitejs/vite/security/advisories
- OpenCVE Vite Tracker: https://app.opencve.io/cve/?vendor=vitejs

**Current Status**: Version 6.2.3 likely includes fixes, but verify with:
```bash
cd frontend
npm audit
```

## Low Priority Vulnerabilities

### 15-20. Various Low Severity Issues
Including dismissed brace-expansion RegExp DoS and legacy code vulnerabilities in `backend/old_frontend/`.

## Stages & Actions

### Stage: Preparation and Backup
- [ ] Pull latest changes from main branch
- [ ] Create backups of dependency files
  ```bash
  cd frontend
  cp package.json package.json.backup
  cp package-lock.json package-lock.json.backup
  ```
- [ ] Run initial security audit to baseline current state
  ```bash
  npm audit --json > security-audit-before.json
  ```

### Stage: Critical Vulnerability Remediation
- [ ] Update jsdom to fix form-data vulnerability
  ```bash
  npm update jsdom
  npm ls form-data  # Verify version is 4.0.4+
  ```
- [ ] Update @sveltejs/kit to fix devalue vulnerability
  ```bash
  npm update @sveltejs/kit
  npm ls devalue  # Verify version is 5.3.2+
  ```
- [ ] Run type checking to ensure no breaking changes
  ```bash
  npm run check
  ```
- [ ] Run tests if available
  ```bash
  npm run test
  ```
- [ ] Manually test critical user flows
  - [ ] Authentication flow
  - [ ] Flashcard functionality
  - [ ] API endpoints

### Stage: Verification and Documentation
- [ ] Run security audit to verify fixes
  ```bash
  npm audit
  npm audit --json > security-audit-after.json
  ```
- [ ] Check GitHub Security tab for updated status
- [ ] Document any breaking changes encountered
- [ ] If Vite vulnerabilities remain, investigate further remediation

### Stage: Long-term Security Improvements
- [ ] Evaluate removal of `backend/old_frontend/` directory
  - [ ] Check for any remaining references
  - [ ] Remove if confirmed unused
- [ ] Configure GitHub Dependabot settings
  - [ ] Enable auto-merge for patch updates
  - [ ] Set up security update notifications
- [ ] Create recurring task for monthly dependency updates
- [ ] Update `docs/SECURITY.md` with security practices

### Stage: Final Health Check
- [ ] Run comprehensive validation
  ```bash
  cd frontend
  npm run build
  npm run check
  npm run test
  ```
- [ ] Review and commit changes following `GIT_COMMITS.md` guidelines
- [ ] Move this doc to `planning/finished/` upon completion

## Risk Assessment

### Production Impact
- **form-data**: HIGH - Affects API security and form submissions
- **devalue**: HIGH - Affects SSR and data serialization
- **Vite**: LOW - Development server only, not production

### Breaking Change Risk
- **@sveltejs/kit update**: LOW - Minor version update
- **jsdom update**: MEDIUM - May have API changes, test thoroughly

## Rollback Plan
If issues occur after updates:
```bash
cd frontend
cp package.json.backup package.json
cp package-lock.json.backup package-lock.json
npm ci
```

## Testing Checklist
After remediation, test:
- [ ] User authentication flow
- [ ] Flashcard functionality
- [ ] File uploads (if applicable)
- [ ] API endpoints
- [ ] Build process (`npm run build`)
- [ ] Type checking (`npm run check`)
- [ ] Unit tests (`npm run test`)

## Timeline
- **Week 1**: Apply critical/high patches
- **Week 2**: Test and deploy to staging
- **Week 3**: Deploy to production
- **Week 4**: Address moderate/low issues

## Notes
- Most Vite vulnerabilities only affect development environment
- Legacy code in `backend/old_frontend/` should be removed if unused
- Consider using `npm audit fix --force` only as last resort
- Monitor GitHub Dependabot for new vulnerabilities

## Appendix

### Vulnerability Research Sources
- CVE-2025-7783 (form-data): Affects all releases prior to 2.5.4, 3.0.0–3.0.3, and 4.0.0–4.0.3
- CVE-2025-57820 (devalue): Prototype pollution via `__proto__` property manipulation
- Vite CVEs: Multiple server.fs.deny bypass methods on case-insensitive filesystems

### Security Best Practices References
- OWASP Insecure Randomness: https://owasp.org/www-community/vulnerabilities/Insecure_Randomness
- CWE-330 (Insufficiently Random Values): https://cwe.mitre.org/data/definitions/330.html
- CWE-1321 (Prototype Pollution): https://cwe.mitre.org/data/definitions/1321.html

### Alternative Approaches Considered
- Using `npm audit fix --force`: Rejected due to high risk of breaking changes
- Pinning exact versions: Rejected in favor of allowing patch updates
- Forking vulnerable packages: Rejected as fixes are available upstream

### Critique of planning doc

#### Strengths
- **Clear prioritization**: Focus on critical/high issues first, with backups and rollback.
- **Verification steps**: Use of `npm audit`, `npm ls`, type check, tests, and manual flow checks.
- **Risk awareness**: Properly flags dev-only Vite issues and cautions on `--force`.
- **Operational hygiene**: Backups before upgrades; Dependabot enablement and recurring updates.

#### Concerns
- **Version/CVE validation**: Fixed versions and CVEs should be verified against current lockfile and official advisories before acting. Ensure the plan references what the project actually has installed (e.g., verify `vite`, `@sveltejs/kit`, `jsdom`, and transitive `devalue`/`form-data` via lockfile).
- **Transitive dependency control**: Updating top-level packages may not bump vulnerable transitives. Missing an `overrides`/`resolutions` strategy to force patched transitive versions when necessary.
- **Backend coverage gap**: Python dependencies (Flask, requests, etc.) are not included. No `pip-audit`/`safety`/`bandit` steps; backend security posture isn’t assessed.

#### Alternatives
- **Force safe transitives**: Use `package.json` `overrides` to pin vulnerable transitives (e.g., `form-data`, `devalue`) when upstreams lag.
- **Additional scanners**: Add `osv-scanner` for Node and Python, or equivalent SCA (GitHub Dependabot/Code Scanning, Renovate, Snyk) with CI integration.
- **Defense-in-depth**: If a transitive can’t be updated immediately, add input hardening/validation and SSR safeguards relevant to `devalue`-style issues until patched.

#### Recommendations
- **Lockfile-grounded validation**:
  - Run: `cd frontend && npm ls devalue form-data vite @sveltejs/kit jsdom | cat`
  - Confirm fixed versions from official advisories before updating the plan.
- **Guarantee patched transitives**:
  - Add `overrides` to `frontend/package.json` when needed:
  ```json
  "overrides": {
    "form-data": ">=4.0.4",
    "devalue": ">=5.3.2"
  }
  ```
  - Remove overrides after upstreams naturally resolve.
- **Backend security coverage**:
  - Add: `pip-audit -r backend/requirements.txt`; `safety check -r backend/requirements.txt`; `bandit -q -r backend`
  - Gate releases on zero critical/high findings.
- **CI/CD gates** (GitHub Actions):
  - Node: `npm ci --ignore-scripts && npm audit --omit=dev --audit-level=high`
  - Python: run `pip-audit`/`safety` and `bandit`
  - Fail the build on critical/high vulns in production deps.
- **Tighten timelines and SLAs**:
  - Critical: 24–48h; High: 7 days; Moderate: 30 days; Low: 90 days.
- **Dev server policy**:
  - Do not expose Vite/Storybook to the public internet; if needed, require VPN/SSH tunnel.
  - Verify Vite config doesn’t expand `server.fs.deny`; avoid `--host` on untrusted networks.
- **Acceptance criteria**:
  - “Production dependency tree: 0 critical/high vulns; audits green; build/check/tests pass.”
- **Housekeeping**:
  - Commit updated `package-lock.json`; use `npm ci` for reproducibility.
  - Consider scanning Storybook dependencies as they often pull vulnerable transitives.

