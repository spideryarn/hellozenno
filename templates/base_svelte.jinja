{% macro load_svelte_component(component_name, props={}, component_id='') %}
  {# Create div with a unique ID for the component to mount to #}
  <div id="{{ component_id if component_id else component_name | lower + '-component' }}" data-svelte-component="{{ component_name }}"
       data-props="{{ props | tojson | replace('"', '&quot;') }}">
    {# Add a loading state that will be replaced when component mounts #}
    <div class="svelte-component-loading">
      {% set display_text = props.text or props.lemma or props.phrase or props.sentence or '' %}
      {% if display_text %}
        <span class="text-content">{{ display_text }}</span>
        {% if props.translations %}
          <span class="translations">
            - {% if props.translations is string %}{{ props.translations }}{% else %}{{ props.translations | join(', ') }}{% endif %}
          </span>
        {% endif %}
      {% endif %}
    </div>
  </div>
  {% if not config.IS_PRODUCTION %}
    {# Development mode - use Vite dev server #}
    <script type="module">
      // Debug flags
      const SVELTE_DEBUG = true;
      console.log('SVELTE DEV COMPONENT LOADING ATTEMPT');
      const debugLog = (msg, ...args) => {
        {# console.log(`[SVELTE DEBUG] ${msg}`, ...args); #}
      };
      
      // Log initial attempt
      debugLog(`Starting mount for ${JSON.stringify({
        component: "{{ component_name }}",
        mountPoint: "{{ component_id if component_id else component_name | lower + '-component' }}",
        props: {{ props | tojson | safe }},
        viteDev: true
      })}`);
      
      // Immediately log what we're going to try to import
      const importUrl = 'http://localhost:5173/src/entries/{{ component_name | lower }}.ts';
      debugLog("Import URL:", importUrl);
      
      // Create a test fetch to see if Vite server is accessible
      fetch(importUrl).then(
        response => debugLog(`Vite server responded with status: ${response.status}`),
        error => debugLog(`Vite server error: ${error.message}`)
      );
      
      try {
        debugLog("Attempting dynamic import...");
        
        // Dynamic import
        import(importUrl).then(
          module => {
            debugLog("Module imported successfully:", module);
            
            if (!module.default) {
              throw new Error(`Module ${importUrl} does not have a default export`);
            }
            
            // Find target element
            const targetElement = document.getElementById('{{ component_id if component_id else component_name | lower + "-component" }}');
            debugLog("Target element:", targetElement);
            
            if (!targetElement) {
              throw new Error(`Target element #{{ component_id if component_id else component_name | lower + "-component" }} not found`);
            }
            
            // Mount component
            const props = {{ props | tojson | safe }};
            debugLog("Mounting with props:", props);
            
            const component = module.default(targetElement, props);
            debugLog("Component mounted successfully:", component);
            
          },
          error => {
            debugLog("Import failed:", error);
            console.error(`Failed to import ${importUrl}:`, error);
          }
        );
      } catch (error) {
        debugLog("Critical error in component loading:", error);
        console.error(`Error loading Svelte component {{ component_name }}:`, error);
      }
    </script>
  {% else %}
    {# Production mode - use built files #}
    <script type="module">
      // Debug flags for troubleshooting production issues
      const PROD_DEBUG = true;
      const debugLog = (msg, ...args) => PROD_DEBUG && console.log(`[SVELTE PROD] ${msg}`, ...args);
      
      try {
        // Use correct filename pattern that matches our build output
        const importUrl = "{{ url_for('static', filename='build/js/' + component_name | lower + '.js') }}";
        debugLog("Loading component from:", importUrl);
        
        // Dynamic import
        import(importUrl).then(
          module => {
            debugLog("Module imported:", Object.keys(module));
            
            // Find target element
            const targetElement = document.getElementById('{{ component_id if component_id else component_name | lower + "-component" }}');
            
            if (!targetElement) {
              throw new Error(`Target element #{{ component_id if component_id else component_name | lower + "-component" }} not found`);
            }
            
            // Mount component
            const props = {{ props | tojson | safe }};
            
            if (typeof module.default !== 'function') {
              console.error("Module default export is not a function:", typeof module.default);
            } else {
              const component = module.default(targetElement, props);
              debugLog("Component mounted successfully");
            }
          },
          error => {
            console.error(`Failed to import ${importUrl}:`, error);
          }
        );
      } catch (error) {
        console.error(`Error loading Svelte component {{ component_name }}:`, error);
      }
    </script>
    
    <style>
      /* Styles for the loading state */
      .svelte-component-loading {
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        margin: 0.25rem 0;
      }
      .svelte-component-loading .text-content {
        font-weight: bold;
        font-size: 1.1rem;
      }
      .svelte-component-loading .translations {
        font-size: 0.875rem;
        color: #64748b;
      }
    </style>
  {% endif %}
{% endmacro %} 